-   name: Assert on 'chdir'
    assert:
        that: (chdir is defined and chdir is not none and chdir | trim != '')
    tags:
    - berkshelf
    - berkshelf_assert
-   name: Create directory
    file:
        path: "{{ berkshelf.cookbook_path }}"
        owner: "{{ ansible_user }}"
        mode: 0755
        state: directory
    become: yes
    tags:
    - berkshelf
    - berkshelf_dir
-   name: Run Berkshelf
    command: bundle exec berks vendor {{ berkshelf.cookbook_path }}
    args:
        chdir: "{{ chdir }}"
    register: run_berkshelf
    changed_when: run_berkshelf.stdout.find('Nothing to update') != -1
    when: berkshelf.cookbook_path is defined
    become: "{{ berkshelf.with_sudo|default(omit) }}"
    tags:
    - berkshelf
    - berkshelf_run
